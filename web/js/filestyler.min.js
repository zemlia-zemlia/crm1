/**
 * FileStyler Legacy
 * @see https://github.com/paulzi/filestyler
 * @license MIT (https://github.com/paulzi/filestyler/blob/master/LICENSE)
 * @version 0.1.2
 */

!function(a,b){"function"==typeof define&&define.amd?define("filestyler",["jquery"],function(a){return b(a)}):"object"==typeof module&&module.exports?module.exports=b(require("jquery")):b(a.jQuery)}(this,function(a){"use strict";function b(){return null===q&&(q="multiple"in document.createElement("input")),q}function c(b,c,d){var e;return e=a.Event(k+c),d&&a.extend(e,d),b.trigger(e),e.isDefaultPrevented()}function d(b){var c=a(this).closest(m).data(k);if(c){var d,e;e=b.target,d=e.files,void 0===d&&(d=[{name:b.target.value.split("\\").pop()}]),c.processFiles(d,e)}}function e(b){b.preventDefault();var c=a(this).closest(m).data(k),d=a(this).closest(n);c.removeItem(d[0])}function f(b){b.preventDefault(),a(this).closest(m).data(k).clear()}function g(b){b.preventDefault(),a(this).closest(m).data(k).$input.trigger("click")}function h(a){this.iframe=!window.FormData,this.filestyler=a,this.queue=[],this.threads=[],this.iframe&&(a.cloneMode="after",a.$input.removeAttr("multiple").prop("multiple",!1)),this.registerSubmitHandler()}function i(a,b){a.config.moveInputOnDrag&&(b.data(k+"Input",[a.$input.parent(),a.$input.next()]),a.$input.addClass(k+"__drop-input"),b.append(a.$input))}function j(a,b){if(a.config.moveInputOnDrag){var c=b.data(k+"Input");c[1].length?c[1].before(a.$input):c[0].append(a.$input),a.$input.removeClass(k+"__drop-input")}}var k="filestyler",l=k+"__item",m="."+k,n="."+l,o="default",p=a(document),q=null,r=function(h){var i,j,l,n,p,q,s,t;for(n=this,n.config=a.extend({},r[o],h),n.$element=i=a(h.element),n.$file=j=i.find(m+"__file").slice(1).remove().addBack().first(),n.$input=l=j.find(m+"__input"),n.$list=i.find(m+"__list"),q=n.config.mode,"byOne"===q&&(l.removeAttr("multiple").prop("multiple",!1),n.cloneMode="item"),("add"===q||"default"===q&&!b())&&(n.cloneMode="after"),n.plugins={},p=0;p<n.config.plugins.length;p++){if(t=n.config.plugins[p],!(s=r.plugins[t]))throw new Error("Plugin "+t+" of FileStyler not found");s=s.create(n),s&&(n.plugins[t]=s)}l.on("change",d),i.on("click",m+"__remove",e),i.on("click",m+"__clear",f),i.on("click",m+"__add",g),i.data(k,n).removeClass(k+"_uninitialized").addClass(k+"_initialized").addClass(k+"_mode_"+n.config.mode),c(i,"Init")};r.prototype.callPlugins=function(b,c){var d=this;a.each(this.plugins,function(e,f){if(f[b]){var g=a.isPlainObject(f)?d:f;f[b].apply(g,c)}})},r.prototype.processFiles=function(a,e){var f,g,h,i,j;if(i=this,!c(i.$element,"BeforeProcess",{files:a,input:e})){for(j=i.config.firstItemInsertBefore,"default"===i.config.mode&&b()&&i.$element.find(n).remove(),i.callPlugins("beforeProcess",[a,e]),f=0;f<a.length;f++)g=i.createItem(a[f],e),h=i.$element.find(n).last(),h.length?h.after(g):(!0===j&&i.$list.prepend(g),!1===j&&i.$list.append(g),i.$list.find(j).before(g)),c(g,"ItemAdd",{item:g[0],file:a[f],input:e});if(i.cloneMode){var l=i.$input.clone(!1).val("");i.$input.addClass(k+"__hidden").after(l),"item"===i.cloneMode?g.append(i.$input):i.$file.before(i.$input),i.$input=l,l.on("change",d)}i.$element.removeClass(k+"_empty"),i.callPlugins("afterProcess",[a,e]),c(i.$element,"Process",{files:a,input:e})}},r.prototype.createItem=function(b,d){var e=this,f={filestyler:e,file:b,fileSizeFormatted:e.config.fileSizeFormatter(b.size,e.config.fileSizeLabels),plugins:{}};e.callPlugins("processFile",[f,b,d]);var g=a(e.config.template(f));if(g.addClass(l),b.type){var h=e.config.mimeMap[b.type];void 0===h&&(h=l+"_"+b.type.replace(/[^\w\d_-]/g,"-")),g.addClass(h)}return e.callPlugins("processItem",[g[0],f,b,d]),c(e.$element,"ProcessItem",{item:g[0],data:f,file:b,input:d}),g},r.prototype.removeItem=function(b){if(-1!==["default","add"].indexOf(this.config.mode))throw new Error('Mode "'+this.config.mode+'" does not support remove item');c(a(b),"BeforeRemoveItem",{item:b})||(this.callPlugins("removeItem",[b]),a(b).remove(),this.$element.toggleClass(k+"_empty",0===this.$list.find(n).length),c(this.$element,"RemoveItem",{item:b}))},r.prototype.clear=function(){c(this.$element,"BeforeClear")||(this.callPlugins("clear",[]),this.$element.find(n).remove(),this.$element.find(m+"__input").filter(m+"__hidden").remove(),this.$input.val(""),this.$element.addClass(k+"_empty"),c(this.$element,"Clear"))},r.prototype.destroy=function(){var a,b;a=this,b=a.$element,a.callPlugins("destroy",[]),a.$input.off("change",d),b.off("click",m+"__remove",e),b.off("click",m+"__clear",f),b.off("click",m+"__add",g),b.removeData(k).addClass(k+"_uninitialized").removeClass(k+"_initialized").removeClass(k+"_mode_"+a.config.mode)},r.fileSizeFormatter=function(a,b){for(var c=0;c<b.length;c++){if(a<1024||c===b.length-1)return Math.round(a)+" "+b[c];a/=1024}return""},r.defaultTemplate=function(b){var c,d;return c=a("<div>"),a.each(b.plugins,function(a,b){c.append(b)}),d=a("<div>").addClass(k+"__info").appendTo(c),a("<div>").addClass(k+"__name").append(b.file.name).appendTo(d),void 0!==b.file.size&&a("<div>").addClass(k+"__size").append(b.fileSizeFormatted).appendTo(d),void 0!==b.file.type&&a("<div>").addClass(k+"__type").append(b.file.type).appendTo(d),a('<button type="button">').addClass(k+"__remove").appendTo(c),c[0]},r.registerPlugin=function(a,b,c){r.plugins[a]=b,c&&r[o].plugins.push(a)},r.plugins={},r.autoInit=!0,r[o]={mode:"add",mimeMap:{},plugins:[],firstItemInsertBefore:!0,template:r.defaultTemplate,fileSizeFormatter:r.fileSizeFormatter,fileSizeLabels:["B","KiB","MiB","GiB","TiB","PiB"]},window.FileStyler=r;var s={create:function(){return s},getName:function(a){var b=a.config.sortHelper;return!0===b?a.$input.attr("name"):"string"==typeof b?b:"function"==typeof b?b(a):null},processFile:function(a){var b=this;if(b.config.sortHelper){var c=b.sortIndex;if(void 0===c){var d=-1;b.$list.find(m+"__sort-helper").each(function(){var a=parseInt(this.value,10)||0;d=a>d?a:d}),c=d}b.sortIndex=c+1,a.sortName=s.getName(b),a.sortValue=c+1,a.plugins.sortHelper=s.template(a)}},template:function(a){return'<input type="hidden" class="'+k+'__sort-helper" name="'+a.sortName+'" value="'+a.sortValue+'"/>'}};r.registerPlugin("sortHelper",s,!0),r[o].sortHelper=!1;var t={create:function(){return t},processFile:function(b,c){var d=this;if(b.isImage=!(!c.type||-1===a.inArray(c.type,d.config.supportedImages)),b.isImage){var e;e=window.URL||window.webkitURL,e&&(b.image=e.createObjectURL(c)),b.plugins.image=t.template()}},processItem:function(b,d,e){var f=function(d){var e=a(b);c(e,"ImageLoad",{item:b,url:d})||(e.find(m+"__image-bg").css("background-image","url("+d+")"),e.find(m+"__image").attr("src",d))};if(a(b).toggleClass(l+"_is-image",d.isImage).toggleClass(l+"_is-no-image",!d.isImage),d.image)f(d.image);else if(d.isImage&&window.FileReader){var g=new FileReader;g.onloadend=function(){f(g.result)},g.readAsDataURL(e)}},template:function(){return'<div class="'+k+"__figure "+k+'__image-bg"><img class="'+k+'__image"/></div>'}};r.registerPlugin("image",t,!0),r[o].supportedImages=["image/jpeg","image/jpg","image/png","image/gif","image/svg+xml"];var u={create:function(){return u},processFile:function(a){if("base64"===this.config.mode){a.isBase64=!0;var b=a.filestyler.$input.attr("name");a.plugins.base64=u.template(b)}},processItem:function(b,d,e){if(d.isBase64){if(!window.FileReader)throw new Error("FileStyler base64 mode not supported");var f;f=new FileReader,f.onloadend=function(){c(a(b),"Base64",{item:b,data:f.result})||a(b).find(m+"__base64").val(f.result)},f.readAsDataURL(e)}},afterProcess:function(){var a=this;"base64"===a.config.mode&&a.$input.val("")},template:function(a){return'<input type="hidden" name="'+a+'" class="'+k+'__base64">'}};r.registerPlugin("base64",u,!0),h.create=function(a){return new h(a)},h.prototype.registerSubmitHandler=function(){var b=this.filestyler.$input.prop("form"),c=this;this.onSubmitHandler=function(a){for(var b=c.queue.length>0,d=0;d<c.threads.length;d++)c.threads[d]&&(b=!0);b&&(a.preventDefault(),c.processQueue())},a(b).on("submit",this.onSubmitHandler)},h.prototype.processFile=function(a){if("ajax"===this.filestyler.config.mode){a.isAjax=!0;var b=a.filestyler.$input.attr("name");a.plugins.ajax=h.template(b)}},h.prototype.processItem=function(b,c,d,e){c.isAjax&&(a(b).addClass(l+"_pause"),this.queue.push({item:b,file:d,input:e}))},h.prototype.afterProcess=function(){var a=this.filestyler;"ajax"===a.config.mode&&(this.iframe||a.$input.val(""),a.config.ajaxImmediately&&this.processQueue())},h.prototype.removeItem=function(a){var b,c;for(this.queue=this.queue.filter(function(b){return b.item!==a}),b=0;b<this.threads.length;b++)(c=this.threads[b])&&c.item===a&&c.$xhr.abort();this.processQueue()},h.prototype.clear=function(){var a,b;for(this.queue=[],a=0;a<this.threads.length;a++)(b=this.threads[a])&&b.$xhr.abort()},h.prototype.processQueue=function(){var a,b;for(b=0;b<this.filestyler.config.simultaneousUploads;b++)this.threads[b]||(a=this.queue.splice(0,1),a.length&&(this.threads[b]=this.upload(a[0],b)))},h.prototype.getUrl=function(){var a=this.filestyler,b=a.config.ajaxUrl;return"string"==typeof b?b:"function"==typeof b?b(a):a.$element.closest("form").attr("action")},h.prototype.upload=function(b,d){var e,f,g,h,i,j;if(e=this,f=this.filestyler,g={url:this.getUrl(),method:"post"},!1!==f.config.timeout&&(g.timeout=f.config.timeout),h=a(b.item),i=h.find(m+"__progress-bar"),j=h.find(m+"__progress-perc"),this.iframe)g.data={name:f.$input.attr("name")},g.files=[b.input],g.iframe=!0,b.input.name="file[]",a(b.input).remove();else{var k=new FormData;k.append("file[]",b.file),k.append("name",f.$input.attr("name")),g.data=k,g.processData=!1,g.contentType=!1,g.xhr=function(){var d=a.ajaxSettings.xhr();return d.upload&&d.upload.addEventListener&&d.upload.addEventListener("progress",function(d){var e;!(e=c(h,"UploadProgress",a.extend({},b,{lengthComputable:d.lengthComputable,loaded:d.loaded,total:d.total})))&&d.lengthComputable&&(i.css("width",d.loaded/d.total*100+"%"),j.html(Math.round(d.loaded/d.total*100)+"%"))}),d}}return c(h,"UploadStart",b)?b:(h.removeClass(l+"_pause").addClass(l+"_progress"),b.$xhr=a.ajax(g).done(function(d){var e,g;e=h.find(m+"__ajax"),(g=c(h,"UploadDone",a.extend({},b,{data:d})))||("replace"===f.config.responseProcessing?e.replaceWith(d):e.val(d),h.removeClass(l+"_progress").addClass(l+"_done"))}).fail(function(){h.removeClass(l+"_progress").addClass(l+"_fail"),c(h,"UploadFail",b)}).always(function(){if(e.threads[d]=!1,h.addClass(l+"_always"),c(h,"UploadEnd",b),e.queue.length)e.processQueue();else if(!c(f.$element,"UploadComplete")&&!f.config.ajaxImmediately){var g=f.$input.prop("form");a(g).trigger("submit")}}),b)},h.prototype.destroy=function(){this.clear();var b=this.filestyler.$input.prop("form");a(b).off("submit",this.onSubmitHandler)},h.template=function(a){var b,c;return b='<input type="hidden" name="'+a+'" class="'+k+'__ajax">',c='<div class="'+k+'__progress"><div class="'+k+'__progress-bar"><div class="'+k+'__progress-perc"></div></div>','<div class="'+k+'__ajax-wrap">'+b+c+"</div>"},r.registerPlugin("ajax",h,!0),a.extend(r[o],{ajaxImmediately:!0,ajaxUrl:!1,responseProcessing:"value",simultaneousUploads:1,timeout:!1});var v={create:function(b){var c,d;c=b.$element.find(m+"__drop"),d=-1!==a.inArray(b.config.mode,b.config.allowDropNoInput),b.drop=0;var e=function(a){a.originalEvent.dataTransfer.files&&(b.drop=b.drop?2:1,b.drop>0&&c.addClass(k+"__drop_hint"))},f=function(a){a.originalEvent.dataTransfer.files&&(b.drop=2===b.drop?1:0,b.drop<=0&&c.removeClass(k+"__drop_hint"))},g=function(){b.drop=0,c.removeClass(k+"__drop_hint")},h=function(c){if(c.originalEvent.dataTransfer.files){var d=a(this);a(c.target).hasClass(k+"__input")||c.preventDefault();var e=d.data(k),f=d.data(k+"Prev");e||(d.addClass(k+"__drop_in"),i(b,d)),d.data(k,1===e&&f!==c.target?2:1),d.data(k+"Prev",c.target)}},l=function(c){if(c.originalEvent.dataTransfer.files){c.preventDefault();var d=a(this),e=2===d.data(k)?1:0;d.data(k,e),d.data(k+"Prev",null),e||(d.removeClass(k+"__drop_in"),j(b,d))}},n=function(a){a.preventDefault()},o=function(c){if(c.originalEvent.dataTransfer.files){var e=a(this);if(e.removeClass(k+"__drop_hint").removeClass(k+"__drop_in").data(k,0),b.drop=0,j(b,e),d&&(c.preventDefault(),b.processFiles(c.originalEvent.dataTransfer.files)),!d&&c.target!==b.$input[0])throw c.preventDefault(),new Error('Mode "'+b.config.mode+'" does not support drop files not on input element (hint: use moveInputOnDrag = true)')}},q=function(a){a.preventDefault()};return b.dropHandlers={documentDragEnter:e,documentDragLeave:f,documentDrop:g,dragEnter:h,dragLeave:l,dragOver:n,drop:o,inputDragOver:q},p.on("dragenter",e),p.on("dragleave",f),p.on("drop",g),c.on("dragenter",h),c.on("dragleave",l),c.on("dragover",n),c.on("drop",o),b.$input.on("dragover",q),v},destroy:function(){var a,b,c;a=this,b=a.dropHandlers,c=a.$element.find(m+"__drop"),p.off("dragenter",b.documentDragEnter),p.off("dragleave",b.documentDragLeave),p.off("drop",b.documentDrop),c.off("dragenter",b.dragEnter),c.off("dragleave",b.dragLeave),c.off("dragover",b.dragOver),c.off("drop",b.drop),a.$input.on("dragover",b.inputDragOver)}};r.registerPlugin("drop",v,!0),r[o].allowDropNoInput=["base64","ajax"],r[o].moveInputOnDrag=!0,a.fn.filestyler=function(b){this.each(function(){new r(a.extend({element:this},b||{},a(this).data(k)||{}))})},a(function(){r.autoInit&&a(m).filestyler()})});